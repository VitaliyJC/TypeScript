const database = [
    {
        id: "vnd331",
        title: "Radisson Royal Hotel",
        details: "Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.",
        photos: ["vnd331.png", "vnd331.png"],
        coordinates: [59.9322936, 30.3460129],
        bookedDates: [],
        price: 12000,
    },
    {
        id: "ab2e2",
        title: "Номера на Садовой",
        details: "Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.",
        photos: ["ab2e2.png", "ab2e2.png"],
        coordinates: [59.930325, 30.3291592],
        bookedDates: [],
        price: 4500,
    },
    {
        id: "mvm32l",
        title: "Мини Отель на Невском 136",
        details: "Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.",
        photos: ["mvm32l.png", "mvm32l.png"],
        coordinates: [59.9299603, 30.3658932],
        bookedDates: [],
        price: 3800,
    },
    {
        id: "bvep12",
        title: "Отель Усадьба Державина",
        details: "Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.",
        photos: ["bvep12.png", "bvep12.png"],
        coordinates: [59.9194966, 30.309389],
        bookedDates: [],
        price: 8700,
    },
];
export function cloneDate(date) {
    return new Date(date.getTime());
}
export function addDays(date, days) {
    date.setDate(date.getDate() + days);
    return date;
}
export const backendPort = 3040;
export const localStorageKey = "flat-rent-db";
export class FlatRentSdk {
    constructor() {
        this._generateTransactionId = () => {
            const min = 1000;
            const max = 9999;
            const num = Math.random() * (max - min) + min;
            return Math.floor(num);
        };
        if (this._readDatabase() == null) {
            this._writeDatabase(database);
        }
        this.database = this._readDatabase();
    }
    /**
     * Get flat by ID.
     *
     * @param {string} id Flat ID.
     * @returns {Promise<Object|null>} Flat.
     */
    get(id) {
        const flat = this.database.find((item) => {
            return item.id === id;
        });
        return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
    }
    /**
     * Search for flats.
     *
     * @param {Object} parameters Search parameters
     * @param {string}parameters.city City name
     * @param {Date} parameters.checkInDate Check-in date
     * @param {Date} parameters.checkOutDate Check-out date
     * @param {number} [parameters.priceLimit] Max price for a night
     * @returns {Object[]} List of suitable flats.
     */
    search(parameters) {
        return new Promise((resolve, reject) => {
            try {
                if (parameters.city != "Санкт-Петербург") {
                    throw new Error(`Passed unsupported city - "${parameters.city}".`);
                }
                if (!(parameters.checkInDate instanceof Date) ||
                    !(parameters.checkOutDate instanceof Date)) {
                    throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
                }
                this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
                if (parameters.priceLimit != null &&
                    (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
                    throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
                }
                let flats = this.database;
                if (parameters.priceLimit != null) {
                    flats = flats.filter((flat) => {
                        return flat.price <= parameters.priceLimit;
                    });
                }
                const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
                flats = flats.filter((flat) => {
                    return this._areAllDatesAvailable(flat, dateRange);
                });
                flats = flats.map((flat) => {
                    return this._formatFlatObject(flat, dateRange.length - 1);
                });
                resolve(flats);
            }
            catch (error) {
                reject(error);
            }
        });
    }
    /**
     * Book flat.
     *
     * @param {number} flatId
     * @param {Date} checkInDate
     * @param {Date} checkOutDate
     * @returns {number}
     */
    book(flatId, checkInDate, checkOutDate) {
        return new Promise((resolve, reject) => {
            try {
                const flat = this.database.find((item) => {
                    return item.id === flatId;
                });
                if (flat == null) {
                    throw new Error('There is no flat with ID "' + flatId + '".');
                }
                this._assertDatesAreCorrect(checkInDate, checkOutDate);
                const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
                if (!this._areAllDatesAvailable(flat, datesToBook)) {
                    throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(",")}.`);
                }
                const bookedDates = datesToBook.map((date) => {
                    return date.getTime();
                });
                flat.bookedDates.push(...bookedDates);
                for (let i = 0; i < this.database.length; i++) {
                    if (this.database[i].id === flat.id) {
                        this.database[i] = flat;
                        break;
                    }
                }
                this._writeDatabase(this.database);
                resolve(this._generateTransactionId());
            }
            catch (error) {
                reject(error);
            }
        });
    }
    _assertDatesAreCorrect(checkInDate, checkOutDate) {
        const today = new Date();
        this._resetTime(today);
        this._resetTime(checkInDate);
        this._resetTime(checkOutDate);
        const diffToday = this._calculateDifferenceInDays(today, checkInDate);
        if (diffToday < 0) {
            throw new Error("Check-in date can't be in the past.");
        }
        const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
        if (diffCheck < 0) {
            throw new Error("Check-out date must be grater then check-in date.");
        }
    }
    _resetTime(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
    }
    _calculateDifferenceInDays(startDate, endDate) {
        const difference = endDate.getTime() - startDate.getTime();
        return Math.floor(difference / (1000 * 60 * 60 * 24));
    }
    _generateDateRange(from, to) {
        const dates = [];
        const differenceInDays = this._calculateDifferenceInDays(from, to);
        dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
        for (let i = 1; i <= differenceInDays; i++) {
            dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
        }
        return dates;
    }
    _areAllDatesAvailable(flat, dateRange) {
        return dateRange.every((date) => {
            return !flat.bookedDates.includes(date.getTime());
        });
    }
    _formatFlatObject(flat, nightNumber) {
        const formattedFlat = Object.assign({}, flat);
        formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
            return `http://localhost:${backendPort}/img/${photoUrl}`;
        });
        if (nightNumber != null) {
            formattedFlat.totalPrice = nightNumber * formattedFlat.price;
            delete formattedFlat.price;
        }
        return formattedFlat;
    }
    _readDatabase() {
        const data = window.localStorage.getItem(localStorageKey);
        if (data == null) {
            return data;
        }
        return JSON.parse(data);
    }
    _writeDatabase(database) {
        window.localStorage.setItem(localStorageKey, JSON.stringify(database));
    }
    _syncDatabase(database) {
        this._writeDatabase(database);
        this.database = this._readDatabase();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZGsvZmxhdC1yZW50LXNkay5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLFFBQVEsR0FBRztJQUNmO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsc0JBQXNCO1FBQzdCLE9BQU8sRUFDTCxnSkFBZ0o7UUFDbEosTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDO1FBQ3JDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLEtBQUs7S0FDYjtJQUNEO1FBQ0UsRUFBRSxFQUFFLE9BQU87UUFDWCxLQUFLLEVBQUUsbUJBQW1CO1FBQzFCLE9BQU8sRUFDTCw2SEFBNkg7UUFDL0gsTUFBTSxFQUFFLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQztRQUNsQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsMkJBQTJCO1FBQ2xDLE9BQU8sRUFDTCwySUFBMkk7UUFDN0ksTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDO1FBQ3JDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUseUJBQXlCO1FBQ2hDLE9BQU8sRUFDTCwwRkFBMEY7UUFDNUYsTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDO1FBQ3BDLFdB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QU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTlDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUMzRCxPQUFPLG9CQUFvQixXQUFXLFFBQVEsUUFBUSxFQUFFLENBQUM7UUFDM0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7WUFDdkIsYUFBYSxDQUFDLFVBQVUsR0FBRyxXQUFXLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQztZQUM3RCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUM7U0FDNUI7UUFFRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRTFELElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxjQUFjLENBQUMsUUFBUTtRQUNyQixNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCxhQUFhLENBQUMsUUFBUTtRQUNwQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRhdGFiYXNlID0gW1xuICB7XG4gICAgaWQ6IFwidm5kMzMxXCIsXG4gICAgdGl0bGU6IFwiUmFkaXNzb24gUm95YWwgSG90ZWxcIixcbiAgICBkZXRhaWxzOlxuICAgICAgXCLQntGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDQg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cc0LDRj9C60L7QstGB0LrQsNGPwrsuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDRhNC40YLQvdC10YEt0YbQtdC90YLRgCDQuCDRgdC/0LAt0YbQtdC90YLRgCDRgSDRgdCw0YPQvdC+0Lkg0Lgg0LPQuNC00YDQvtC80LDRgdGB0LDQttC90L7QuSDQstCw0L3QvdC+0LkuXCIsXG4gICAgcGhvdG9zOiBbXCJ2bmQzMzEucG5nXCIsIFwidm5kMzMxLnBuZ1wiXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkzMjI5MzYsIDMwLjM0NjAxMjldLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogMTIwMDAsXG4gIH0sXG4gIHtcbiAgICBpZDogXCJhYjJlMlwiLFxuICAgIHRpdGxlOiBcItCd0L7QvNC10YDQsCDQvdCwINCh0LDQtNC+0LLQvtC5XCIsXG4gICAgZGV0YWlsczpcbiAgICAgIFwi0KDQsNGB0L/QvtC70L7QttC10L0g0LIgNyDQvNC40L3Rg9GC0LDRhSDRhdC+0LTRjNCx0Ysg0L7RgiDQndC10LLRgdC60L7Qs9C+INC/0YDQvtGB0L/QtdC60YLQsC4g0Jog0YPRgdC70YPQs9Cw0Lwg0LPQvtGB0YLQtdC5INC60YDRg9Cz0LvQvtGB0YPRgtC+0YfQvdCw0Y8g0YHRgtC+0LnQutCwINGA0LXQs9C40YHRgtGA0LDRhtC40Lgg0Lgg0LHQtdGB0L/Qu9Cw0YLQvdGL0LkgV2ktRmkuXCIsXG4gICAgcGhvdG9zOiBbXCJhYjJlMi5wbmdcIiwgXCJhYjJlMi5wbmdcIl0sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzAzMjUsIDMwLjMyOTE1OTJdLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogNDUwMCxcbiAgfSxcbiAge1xuICAgIGlkOiBcIm12bTMybFwiLFxuICAgIHRpdGxlOiBcItCc0LjQvdC4INCe0YLQtdC70Ywg0L3QsCDQndC10LLRgdC60L7QvCAxMzZcIixcbiAgICBkZXRhaWxzOlxuICAgICAgXCLQnNC40L3QuC3QvtGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyINCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCz0LUsINCyIDUg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cf0LvQvtGJ0LDQtNGMINCS0L7RgdGB0YLQsNC90LjRj8K7INC4INCc0L7RgdC60L7QstGB0LrQvtCz0L4g0LbQtdC70LXQt9C90L7QtNC+0YDQvtC20L3QvtCz0L4g0LLQvtC60LfQsNC70LAuXCIsXG4gICAgcGhvdG9zOiBbXCJtdm0zMmwucG5nXCIsIFwibXZtMzJsLnBuZ1wiXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkyOTk2MDMsIDMwLjM2NTg5MzJdLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogMzgwMCxcbiAgfSxcbiAge1xuICAgIGlkOiBcImJ2ZXAxMlwiLFxuICAgIHRpdGxlOiBcItCe0YLQtdC70Ywg0KPRgdCw0LTRjNCx0LAg0JTQtdGA0LbQsNCy0LjQvdCwXCIsXG4gICAgZGV0YWlsczpcbiAgICAgIFwi0J/RgNC10LrRgNCw0YHQvdGL0Lkg0L7RgtC10LvRjCDQvdC10LTQsNC70LXQutC+INC+0YIg0JjRgdCw0LDQutC40LXQstGB0LrQvtCz0L4g0YHQvtCx0L7RgNCwINGBINCx0LXRgdC/0LvQsNGC0L3Ri9C8IFdpLUZpINC90LAg0LLRgdC10Lkg0YLQtdGA0YDQuNGC0L7RgNC40LguXCIsXG4gICAgcGhvdG9zOiBbXCJidmVwMTIucG5nXCIsIFwiYnZlcDEyLnBuZ1wiXSxcbiAgICBjb29yZGluYXRlczogWzU5LjkxOTQ5NjYsIDMwLjMwOTM4OV0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiA4NzAwLFxuICB9LFxuXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNsb25lRGF0ZShkYXRlKSB7XG4gIHJldHVybiBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGREYXlzKGRhdGUsIGRheXMpIHtcbiAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpICsgZGF5cyk7XG4gIHJldHVybiBkYXRlO1xufVxuXG5leHBvcnQgY29uc3QgYmFja2VuZFBvcnQgPSAzMDQwO1xuZXhwb3J0IGNvbnN0IGxvY2FsU3RvcmFnZUtleSA9IFwiZmxhdC1yZW50LWRiXCI7XG5cbmV4cG9ydCBjbGFzcyBGbGF0UmVudFNkayB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGlmICh0aGlzLl9yZWFkRGF0YWJhc2UoKSA9PSBudWxsKSB7XG4gICAgICB0aGlzLl93cml0ZURhdGFiYXNlKGRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGFiYXNlID0gdGhpcy5fcmVhZERhdGFiYXNlKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGZsYXQgYnkgSUQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBGbGF0IElELlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IEZsYXQuXG4gICAqL1xuICBnZXQoaWQpIHtcbiAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gaXRlbS5pZCA9PT0gaWQ7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZsYXQgPT0gbnVsbCA/IGZsYXQgOiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWFyY2ggZm9yIGZsYXRzLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBTZWFyY2ggcGFyYW1ldGVyc1xuICAgKiBAcGFyYW0ge3N0cmluZ31wYXJhbWV0ZXJzLmNpdHkgQ2l0eSBuYW1lXG4gICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja0luRGF0ZSBDaGVjay1pbiBkYXRlXG4gICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja091dERhdGUgQ2hlY2stb3V0IGRhdGVcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtwYXJhbWV0ZXJzLnByaWNlTGltaXRdIE1heCBwcmljZSBmb3IgYSBuaWdodFxuICAgKiBAcmV0dXJucyB7T2JqZWN0W119IExpc3Qgb2Ygc3VpdGFibGUgZmxhdHMuXG4gICAqL1xuICBzZWFyY2gocGFyYW1ldGVycykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAocGFyYW1ldGVycy5jaXR5ICE9IFwi0KHQsNC90LrRgi3Qn9C10YLQtdGA0LHRg9GA0LNcIikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHVuc3VwcG9ydGVkIGNpdHkgLSBcIiR7cGFyYW1ldGVycy5jaXR5fVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICEocGFyYW1ldGVycy5jaGVja0luRGF0ZSBpbnN0YW5jZW9mIERhdGUpIHx8XG4gICAgICAgICAgIShwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBpbnN0YW5jZW9mIERhdGUpXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBQYXNzZWQgaW52YWxpZCBjaGVjay1pbiBvciBjaGVjay1vdXQgZGF0ZSAtIGZyb20gXCIke3BhcmFtZXRlcnMuY2hlY2tJbkRhdGV9XCIgdG8gXCIke3BhcmFtZXRlcnMuY2hlY2tPdXREYXRlfVwiLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fzc2VydERhdGVzQXJlQ29ycmVjdChcbiAgICAgICAgICBwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlLFxuICAgICAgICAgIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgIHBhcmFtZXRlcnMucHJpY2VMaW1pdCAhPSBudWxsICYmXG4gICAgICAgICAgKGlzTmFOKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkgfHwgIWlzRmluaXRlKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkpXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBQYXNzZWQgaW52YWxpZCBwcmljZSBsaW1pdCAtIFwiJHtwYXJhbWV0ZXJzLnByaWNlTGltaXR9XCIuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmxhdHMgPSB0aGlzLmRhdGFiYXNlO1xuXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCkge1xuICAgICAgICAgIGZsYXRzID0gZmxhdHMuZmlsdGVyKChmbGF0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZmxhdC5wcmljZSA8PSBwYXJhbWV0ZXJzLnByaWNlTGltaXQ7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYXRlUmFuZ2UgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShcbiAgICAgICAgICBwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlLFxuICAgICAgICAgIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlXG4gICAgICAgICk7XG4gICAgICAgIGZsYXRzID0gZmxhdHMuZmlsdGVyKChmbGF0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVSYW5nZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZsYXRzID0gZmxhdHMubWFwKChmbGF0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2Zvcm1hdEZsYXRPYmplY3QoZmxhdCwgZGF0ZVJhbmdlLmxlbmd0aCAtIDEpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXNvbHZlKGZsYXRzKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQm9vayBmbGF0LlxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gZmxhdElkXG4gICAqIEBwYXJhbSB7RGF0ZX0gY2hlY2tJbkRhdGVcbiAgICogQHBhcmFtIHtEYXRlfSBjaGVja091dERhdGVcbiAgICogQHJldHVybnMge251bWJlcn1cbiAgICovXG4gIGJvb2soZmxhdElkLCBjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZsYXQgPSB0aGlzLmRhdGFiYXNlLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gZmxhdElkO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZmxhdCA9PSBudWxsKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGVyZSBpcyBubyBmbGF0IHdpdGggSUQgXCInICsgZmxhdElkICsgJ1wiLicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fzc2VydERhdGVzQXJlQ29ycmVjdChjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKTtcblxuICAgICAgICBjb25zdCBkYXRlc1RvQm9vayA9IHRoaXMuX2dlbmVyYXRlRGF0ZVJhbmdlKGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpO1xuICAgICAgICBpZiAoIXRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVzVG9Cb29rKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBGbGF0ICR7ZmxhdC5pZH0gaXMgbm90IGF2YWlsYWJsZSBmb3IgZGF0ZXMgJHtkYXRlc1RvQm9vay5qb2luKFxuICAgICAgICAgICAgICBcIixcIlxuICAgICAgICAgICAgKX0uYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBib29rZWREYXRlcyA9IGRhdGVzVG9Cb29rLm1hcCgoZGF0ZSkgPT4ge1xuICAgICAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGZsYXQuYm9va2VkRGF0ZXMucHVzaCguLi5ib29rZWREYXRlcyk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5kYXRhYmFzZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmICh0aGlzLmRhdGFiYXNlW2ldLmlkID09PSBmbGF0LmlkKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGFiYXNlW2ldID0gZmxhdDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKHRoaXMuZGF0YWJhc2UpO1xuXG4gICAgICAgIHJlc29sdmUodGhpcy5fZ2VuZXJhdGVUcmFuc2FjdGlvbklkKCkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIF9hc3NlcnREYXRlc0FyZUNvcnJlY3QoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSkge1xuICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICB0aGlzLl9yZXNldFRpbWUodG9kYXkpO1xuICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja0luRGF0ZSk7XG4gICAgdGhpcy5fcmVzZXRUaW1lKGNoZWNrT3V0RGF0ZSk7XG5cbiAgICBjb25zdCBkaWZmVG9kYXkgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKHRvZGF5LCBjaGVja0luRGF0ZSk7XG4gICAgaWYgKGRpZmZUb2RheSA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNoZWNrLWluIGRhdGUgY2FuJ3QgYmUgaW4gdGhlIHBhc3QuXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGRpZmZDaGVjayA9IHRoaXMuX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoXG4gICAgICBjaGVja0luRGF0ZSxcbiAgICAgIGNoZWNrT3V0RGF0ZVxuICAgICk7XG4gICAgaWYgKGRpZmZDaGVjayA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNoZWNrLW91dCBkYXRlIG11c3QgYmUgZ3JhdGVyIHRoZW4gY2hlY2staW4gZGF0ZS5cIik7XG4gICAgfVxuICB9XG5cbiAgX3Jlc2V0VGltZShkYXRlKSB7XG4gICAgZGF0ZS5zZXRIb3VycygwKTtcbiAgICBkYXRlLnNldE1pbnV0ZXMoMCk7XG4gICAgZGF0ZS5zZXRTZWNvbmRzKDApO1xuICAgIGRhdGUuc2V0TWlsbGlzZWNvbmRzKDApO1xuICB9XG5cbiAgX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoc3RhcnREYXRlLCBlbmREYXRlKSB7XG4gICAgY29uc3QgZGlmZmVyZW5jZSA9IGVuZERhdGUuZ2V0VGltZSgpIC0gc3RhcnREYXRlLmdldFRpbWUoKTtcblxuICAgIHJldHVybiBNYXRoLmZsb29yKGRpZmZlcmVuY2UgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpO1xuICB9XG5cbiAgX2dlbmVyYXRlRGF0ZVJhbmdlKGZyb20sIHRvKSB7XG4gICAgY29uc3QgZGF0ZXMgPSBbXTtcbiAgICBjb25zdCBkaWZmZXJlbmNlSW5EYXlzID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhmcm9tLCB0byk7XG5cbiAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSkpO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IGRpZmZlcmVuY2VJbkRheXM7IGkrKykge1xuICAgICAgZGF0ZXMucHVzaChcbiAgICAgICAgbmV3IERhdGUoZnJvbS5nZXRGdWxsWWVhcigpLCBmcm9tLmdldE1vbnRoKCksIGZyb20uZ2V0RGF0ZSgpICsgaSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGVzO1xuICB9XG5cbiAgX2dlbmVyYXRlVHJhbnNhY3Rpb25JZCA9ICgpID0+IHtcbiAgICBjb25zdCBtaW4gPSAxMDAwO1xuICAgIGNvbnN0IG1heCA9IDk5OTk7XG4gICAgY29uc3QgbnVtID0gTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pICsgbWluO1xuXG4gICAgcmV0dXJuIE1hdGguZmxvb3IobnVtKTtcbiAgfTtcblxuICBfYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKSB7XG4gICAgcmV0dXJuIGRhdGVSYW5nZS5ldmVyeSgoZGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuICFmbGF0LmJvb2tlZERhdGVzLmluY2x1ZGVzKGRhdGUuZ2V0VGltZSgpKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIG5pZ2h0TnVtYmVyKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkRmxhdCA9IE9iamVjdC5hc3NpZ24oe30sIGZsYXQpO1xuXG4gICAgZm9ybWF0dGVkRmxhdC5waG90b3MgPSBmb3JtYXR0ZWRGbGF0LnBob3Rvcy5tYXAoKHBob3RvVXJsKSA9PiB7XG4gICAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtiYWNrZW5kUG9ydH0vaW1nLyR7cGhvdG9Vcmx9YDtcbiAgICB9KTtcblxuICAgIGlmIChuaWdodE51bWJlciAhPSBudWxsKSB7XG4gICAgICBmb3JtYXR0ZWRGbGF0LnRvdGFsUHJpY2UgPSBuaWdodE51bWJlciAqIGZvcm1hdHRlZEZsYXQucHJpY2U7XG4gICAgICBkZWxldGUgZm9ybWF0dGVkRmxhdC5wcmljZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm9ybWF0dGVkRmxhdDtcbiAgfVxuXG4gIF9yZWFkRGF0YWJhc2UoKSB7XG4gICAgY29uc3QgZGF0YSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShsb2NhbFN0b3JhZ2VLZXkpO1xuXG4gICAgaWYgKGRhdGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gIH1cblxuICBfd3JpdGVEYXRhYmFzZShkYXRhYmFzZSkge1xuICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShsb2NhbFN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KGRhdGFiYXNlKSk7XG4gIH1cblxuICBfc3luY0RhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSk7XG4gICAgdGhpcy5kYXRhYmFzZSA9IHRoaXMuX3JlYWREYXRhYmFzZSgpO1xuICB9XG59XG4iXX0=